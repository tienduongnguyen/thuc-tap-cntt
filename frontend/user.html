<!DOCTYPE html>
<html>
  <head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css"       
    integrity="sha384-zCbKRCUGaJDkqS1kPbPd7TveP5iyJE0EjAuZQTgFLD2ylzuqKfdKlfG/eSrtxUkn" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" 
    integrity="sha384-fQybjgWLrvvRgtW6bFlB7jaZrFsaBXjsOMm/tB9LTS58ONXgqbR9W8oWht/amnpF" crossorigin="anonymous"></script>

    <link rel="icon" href="./images/icon.png">
    <title>Cổng Thông tin điện tử Chính Phủ</title>
  </head>
  <body>
    <style>
      .my-center {
        text-align: center;
        margin-top: 60px;
        margin-bottom: 10px;
      }
      .my-td {
        text-align: center;
        width: 390px;
      }
      .my-btn {
        float: right;
      }
      .my-submit-btn {
        width: 100px;
        float: right;
      }
      .my-popup-btn {
        width: 65px;
      }
      .my-span {
        margin-bottom: 5px;
      }
      .bg-header {
        text-align: center;
        margin-bottom: 10px;
        height: 225px;
        padding-top: 50px;
        background-image: url("./images/bg.png");
        background-repeat: no-repeat;
      }
    </style>
    <div class="bg-header" tabindex="0"></div>
    <div class="container">
      <table class="table table-borderless">
        <tr>
          <td>
            <table class="table">
              <thead class="text-black">
                <tr>
                  <th colspan="3" class="my-center"><h3 class="font-weight-bold">CHÍNH PHỦ</h3></th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Kiểm tra tên của tài khoản</td>
                  <td>
                    <div class="input-group input-group-sm">
                      <div class="input-group-prepend">
                        <span class="input-group-text" id="inputGroup-sizing-sm">Địa chỉ</span>
                      </div>
                      <input id="addressName" type="text" class="form-control" aria-label="Small" 
                            aria-describedby="inputGroup-sizing-sm" placeholder="0xCeA2a20F681169BEe6Cfb04F446b61c5B45cf8E4">
                    </div>
                  </td>
                  <td>
                    <button onclick="checkNameAddress()" type="submit" class="btn btn-danger btn-sm my-submit-btn">Gửi</button>
                  </td>
                </tr>
                <tr>
                  <td>Kiểm tra tài khoản của tên</td>
                  <td>
                    <div class="input-group input-group-sm">
                      <div class="input-group-prepend">
                        <span class="input-group-text" id="inputGroup-sizing-sm">Tên TK</span>
                      </div>
                      <input id="nameAddress" type="text" class="form-control" aria-label="Small" 
                            aria-describedby="inputGroup-sizing-sm" placeholder="Ha Noi">
                    </div>
                  </td>
                  <td>
                    <button onclick="checkAddressName()" type="submit" class="btn btn-danger btn-sm my-submit-btn">Gửi</button>
                  </td>
                </tr>
                <tr>
                  <td>Danh sách tài khoản</td>
                  <td></td>
                  <td>
                    <button onclick="listAddress()" type="submit" class="btn btn-danger btn-sm my-submit-btn">Gửi</button>
                  </td>
                </tr>
              </tbody>
            </table>
            <table class="table">
              <thead class="text-black">
                <tr>
                  <th colspan="3" class="my-center"><h3 class="font-weight-bold">BẦU CỬ</h3></th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Quét mã QR</td>
                  <td>
                    <div class="input-group input-group-sm">
                      <div class="input-group-prepend">
                        <span class="input-group-text" id="inputGroup-sizing-sm">Hình ảnh</span>
                      </div>
                      <input id="imageScan" type="text" class="form-control" aria-label="Small" 
                            aria-describedby="inputGroup-sizing-sm" placeholder="https://gateway.pinata.cloud/ipfs/">
                    </div>
                  </td>
                  <td>
                    <button onclick="scanQrCode()" type="submit" class="btn btn-danger btn-sm my-submit-btn">Gửi</button>
                  </td>
                </tr>
                <tr>
                  <td>Bầu cử</td>
                  <td>
                    <div class="input-group input-group-sm my-span">
                      <div class="input-group-prepend">
                        <span class="input-group-text" id="inputGroup-sizing-sm">Hình ảnh</span>
                      </div>
                      <input id="imageVote" type="text" class="form-control" aria-label="Small" 
                            aria-describedby="inputGroup-sizing-sm" placeholder="https://gateway.pinata.cloud/ipfs/">
                    </div>
                    <div class="input-group input-group-sm">
                      <div class="input-group-prepend">
                        <label class="input-group-text" for="optionVote">Bỏ phiếu</label>
                      </div>
                      <select class="custom-select" id="optionVote">
                        <option value="0">Chọn...</option>
                        <option id="val-1" value="1">Nguyen Van A</option>
                        <option id="val-2" value="2">Nguyen Van B</option>
                        <option id="val-3" value="3">Nguyen Van C</option>
                        <option id="val-4" value="4">Nguyen Van D</option>
                        <option id="val-5" value="5">Nguyen Van E</option>
                      </select>
                    </div>
                  </td>
                  <td>
                    <div class="modal fade" id="popupVote" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                      <div class="modal-dialog" role="document">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Thông báo</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                              <span aria-hidden="true">&times;</span>
                            </button>
                          </div>
                          <div class="modal-body">
                            <div>Yêu cầu của bạn đã được gửi đi <ion-icon name="thumbs-up-outline"></ion-icon></ion-icon></div>
                            <div>Vui lòng đợi kết quả trong giây lát...</div> 
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-danger btn-sm my-popup-btn" data-dismiss="modal" aria-label="Close">OK</button>
                          </div>
                        </div>
                      </div>
                    </div>
                    <button onclick="vote()" type="submit" class="btn btn-danger btn-sm my-submit-btn" data-toggle="modal" data-target="#popupVote">Gửi</button>
                  </td>
                </tr>
                <tr>
                  <td>Kiểm tra phiếu bầu</td>
                  <td>
                    <div class="input-group input-group-sm">
                      <div class="input-group-prepend">
                        <span class="input-group-text" id="inputGroup-sizing-sm">Hình ảnh</span>
                      </div>
                      <input id="imageCheck" type="text" class="form-control" aria-label="Small" 
                            aria-describedby="inputGroup-sizing-sm" placeholder="https://gateway.pinata.cloud/ipfs/">
                    </div>
                  </td>
                  <td>
                    <button onclick="checkVote()" type="submit" class="btn btn-danger btn-sm my-submit-btn">Gửi</button>
                  </td>
                </tr>
                <tr>
                  <td>Thống kê phiếu bầu</td>
                  <td></td>
                  <td>
                    <button onclick="countVote()" type="submit" class="btn btn-danger btn-sm my-submit-btn">Gửi</button>
                  </td>
                </tr>
                <tr>
                  <td>Lịch sử bầu cử</td>
                  <td></td>
                  <td>
                    <button onclick="listVote()" type="submit" class="btn btn-danger btn-sm my-submit-btn">Gửi</button>
                  </td>
                </tr>
                <tr>
                  <td>Tổng số phiếu bầu</td>
                  <td></td>
                  <td>
                    <button onclick="totalVote()" type="submit" class="btn btn-danger btn-sm my-submit-btn">Gửi</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </td>
          <td>
            <table id="result-p" class="table table-hover">
              <thead class="text-black">
                <tr>
                  <tr>
                    <th class="my-center">
                      <h3 class="font-weight-bold">KẾT QUẢ
                        <button onclick="clearText()" type="submit" class="btn my-btn"><ion-icon name="backspace"></ion-icon></button>
                      </h3>
                    </th>
                  </tr>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td id="result-p-0" class="my-td"></td>
                </tr>
              </tbody>
            </table>
          </td>
        </tr>
      </table>
    </div>
  </body>

  <script>
    let rows = 1;
    const clearText = () => {
      $("#addressName").val("");
      $("#nameAddress").val("");
      $("#result-p-0").text("");
      $("#imageScan").val("");
      $("#imageVote").val("");
      $("#optionVote").val(0);
      $("#imageCheck").val("");
      for (let i=1; i<rows; i++) {
        $(`#result-p-r-${i}`).remove();
      }
      rows = 1;
    };
    const initResult = (keys, values) => {
      $("#result-p-0").text(`${keys[0]}: ${values[0]}`);
      rows = keys.length;
      for (let i=1; i<rows; i++) {
        if (keys[i] == "Vote for") values[i] = idToName(values[i]);
        $('#result-p tr:last').after(`
          <tr id="result-p-r-${i}"><td class="my-td">${keys[i]}: ${values[i]}</td></tr>
        `);
      }
    };
    const initResultForCountVote = (keys, values) => {
      $("#result-p-0").text(`${idToName(parseInt(keys[0]))}: ${values[0]}`);
      rows = keys.length;
      for (let i=1; i<rows; i++) {
        keys[i] = idToName(parseInt(keys[i]));
        $('#result-p tr:last').after(`
          <tr id="result-p-r-${i}"><td class="my-td">${keys[i]}: ${values[i]}</td></tr>
        `);
      }
    };
    const initResultForListVote = (keys, values) => {
      $("#result-p-0").text(`${keys[0]} ${idToName(parseInt(values[0]["Vote for"]))} - ${values[0]["Vote at"]}`);
      rows = keys.length;
      for (let i=1; i<rows; i++) {
        let voteFor = idToName(parseInt(values[i]["Vote for"]));
        let voteAt = values[i]["Vote at"];
        $('#result-p tr:last').after(`
          <tr id="result-p-r-${i}"><td class="my-td">${keys[i]} ${voteFor} - ${voteAt}</td></tr>
        `);
      }
    };
    const idToName = (id) => {
      return $(`#val-${id}`).text();
    };
    const checkNameAddress = async () => {
      const query = $("#addressName").val();
      clearText();
      $("#addressName").val(query);
      const url = "http:/localhost:8088/api/gov/name?address=" + query;
      const response = await fetch(url);
      const myJson = await response.json();
      if (myJson.code == 200) $("#result-p-0").text(myJson.data);
      else alert("Địa chỉ không hợp lệ");
    };
    const checkAddressName = async () => {
      const query = $("#nameAddress").val();
      clearText();
      $("#nameAddress").val(query);
      const url = "http:/localhost:8088/api/gov/address?name=" + query;
      const response = await fetch(url);
      const myJson = await response.json();
      if (myJson.code == 200) $("#result-p-0").text(myJson.data);
      else alert("Tên không tồn tại");
    };
    const listAddress = async () => {
      clearText();
      const url = "http:/localhost:8088/api/gov/list";
      const response = await fetch(url);
      const myJson = await response.json();
      const keys = Object.keys(myJson.data);
      const values = Object.values(myJson.data);
      initResult(keys, values);
    };
    const scanQrCode = async () => {
      const query = $("#imageScan").val();
      clearText();
      $("#imageScan").val(query);
      const url = "http:/localhost:8088/api/vote/scan?image_url=" + query;
      const response = await fetch(url);
      const myJson = await response.json();
      if (myJson.code == 200) {
        const keys = Object.keys(myJson.data);
        const values = Object.values(myJson.data);
        initResult(keys, values);
      }
      else alert("Hình ảnh không hợp lệ");
    };
    const vote = async () => {
      const query1 = $("#imageVote").val();
      let query2 = $("#optionVote").val();
      clearText();
      $("#imageVote").val(query1);
      $("#optionVote").val(query2);
      $.post("http:/localhost:8088/api/vote/voting",
      {
        image_url: query1,
        option: parseInt(query2),
      }, function (res, status) {
        if (res.code == 200) {
          const keys = Object.keys(res.data);
          const values = Object.values(res.data);
          alert("Bạn đã bầu cử thành công")
          initResult(keys, values);
        }
        else alert("Có gì đó sai sai");
      });
    };
    const checkVote = async () => {
      const query = $("#imageCheck").val();
      clearText();
      $("#imageCheck").val(query);
      const url = "http://localhost:8088/api/vote/check-my-vote?image_url=" + query;
      const response = await fetch(url);
      const myJson = await response.json();
      if (myJson.code == 200) {
        const keys = Object.keys(myJson.data);
        const values = Object.values(myJson.data);
        initResult(keys, values);
      }
      else alert("Hình ảnh không hợp lệ");
    };
    const countVote = async () => {
      clearText();
      const url = "http:/localhost:8088/api/vote/count-voted";
      const response = await fetch(url);
      const myJson = await response.json();
      const keys = Object.keys(myJson.data);
      const values = Object.values(myJson.data);
      initResultForCountVote(keys, values);
    };
    const listVote = async () => {
      clearText();
      const url = "http:/localhost:8088/api/vote/list-voted";
      const response = await fetch(url);
      const myJson = await response.json();
      const keys = Object.keys(myJson.data);
      const values = Object.values(myJson.data);
      initResultForListVote(keys, values);
    };
    const totalVote = async () => {
      clearText();
      const url = "http:/localhost:8088/api/vote/total-voted";
      const response = await fetch(url);
      const myJson = await response.json();
      $("#result-p-0").text(myJson.data);
    };
  </script>
</html>
